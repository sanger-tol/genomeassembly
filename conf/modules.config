/*

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

/*
    Local functions for determining output directories and file names.
    Not a particularly great solution - not compliant with strict syntax.

    Replace ASAP with the new output publishing!
*/
mf {

    assemblyDir = { meta, starttime ->
        def asm_dir_name = "hifiasm"
        if (meta.assembly_type == "hic_phased") {
            asm_dir_name = "hifiasm-hic"
        } else if (meta.assembly_type == "trio_binned") {
            asm_dir_name = "hifiasm-trio"
        }

        def date = "${starttime.format('yyyyMMdd')}"
        return "${meta.id}.${asm_dir_name}.${date}"
    }

    subDir = { meta ->
        def subdir_name = ""
        if (meta.assembly_stage == "purged") {
            subdir_name = "purging"
        } else if (meta.assembly_stage == "polished") {
            subdir_name = "polishing"
        } else if (meta.assembly_stage == "scaffolded") {
            hapdir = meta._hap ?: "hap1"
            subdir_name = "scaffolding_${hapdir}/yahs/"
        }

        return subdir_name
    }
}

process {

    withName: 'CONCATENATE_ASSEMBLIES' {
        tag        = { "${meta.assembly_type}" }
        ext.prefix = { "asm.concat"            }
    }

    withName: 'SEQKIT_GREP_SPLIT_HAPS' {
        ext.prefix = { "asm_${meta._hap}" }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        ext.args   = {
            meta._hap == "hap1" ? "-rp '^h1tg|^ptg'" : "-rp '^h2tg|^atg|^hap_'"
        }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/polishing" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'BGZIP_ASSEMBLIES' {
        ext.prefix = { "${input.getBaseName()}" }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/" + "${mf.subDir(meta)}" + "/" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:GENOME_STATISTICS:ASMSTATS' {
        ext.prefix = { "${assembly.getName()}" }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/" + "${mf.subDir(meta)}" + "/" },
            mode: params.publish_dir_mode,
            pattern: '*.stats'
        ]
    }

    withName: '.*:GENOME_STATISTICS:GFASTATS' {
        ext.prefix = { "${assembly.getName()}" }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/" + "${mf.subDir(meta)}" + "/" },
            mode: params.publish_dir_mode,
            pattern: '*.assembly_summary'
        ]
    }

    withName: '.*:GENOME_STATISTICS:BUSCO_BUSCO' {
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        ext.args = {
            [
                params.busco_lineage_directory ? "--offline" : "",
                "--skip_bbtools" // Temporary until https://gitlab.com/ezlab/busco/-/issues/821 fixed
            ].join(" ").trim()
        }
        publishDir = [
            path: {
                [
                    "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/",
                    "${mf.subDir(meta)}",
                    "/${fasta.getBaseName()}.${lineage}.busco/"
                ].join("").trim()
            },
            mode: params.publish_dir_mode,
            saveAs: { filename -> !(filename.endsWith('faa') || filename.endsWith('fna')) ? filename : null }
        ]
    }

    withName: '.*:GENOME_STATISTICS:MERQURYFK_MERQURYFK' {
        tag        = { "${meta.assembly_type}" }
        ext.prefix = { "${meta.id}.ccs" }
        publishDir = [
            path: {
                [
                    "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/",
                    "${mf.subDir(meta)}",
                    "/${assembly.getBaseName()}.ccs.merquryfk/"
                ].join("").trim()
            },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:KMERS:FASTK_FASTK' {
        ext.args   = { "-k${params.kmer_size} -t -P." }
        ext.prefix = { "${meta.id}.${meta.read_type}.${params.kmer_size}" }
        tag        = { "${meta.id}.${meta.read_type}.${params.kmer_size}" }
        publishDir = [
            path: { "${params.outdir}/kmer/k${meta.kmer_size}/${meta.read_type}/" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:KMERS:FASTK_HISTEX' {
        ext.prefix = { "${meta.id}.${meta.read_type}.${meta.kmer_size}" }
        ext.args   = "-G"
        tag        = { "${meta.id}.${meta.read_type}.${meta.kmer_size}" }
        publishDir = [
            path: { "${params.outdir}/kmer/k${meta.kmer_size}/${meta.read_type}/" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:KMERS:GENOMESCOPE2' {
        ext.prefix = { "${meta.id}.${meta.read_type}.${meta.kmer_size}" }
        ext.args   = { "-k${meta.kmer_size}"                            }
        tag        = { "${meta.id}.${meta.read_type}.${meta.kmer_size}" }
        publishDir = [
            path: { "${params.outdir}/kmer/k${meta.kmer_size}/${meta.read_type}/" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:KMERS:MERQURYFK_HAPMAKER' {
        ext.prefix = { "${meta.id}.${meta.read_type}.${meta.kmer_size}" }
        tag        = { "${meta.id}.${meta.read_type}.${meta.kmer_size}" }
        publishDir = [
            path: { "${params.outdir}/kmer/k${meta.kmer_size}/trio" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:KMERS:YAK_COUNT' {
        ext.prefix = { "${meta.id}_${meta.read_type}"     }
        ext.args   = { "-k${params.kmer_size}"            }
        tag        = { "${meta.id}_yak_${meta.read_type}" }
        publishDir = [
            path: { "${params.outdir}/kmer/${meta.kmer_size}/${meta.read_type}/" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:ORGANELLE_ASSEMBLY:CONCATENATE_ASSEMBLIES' {
        tag        = { "${meta.assembly_type}" }
        ext.prefix = { "asm.concat.fa" }
    }

    withName: '.*:ORGANELLE_ASSEMBLY:CONCATENATE_INPUT_READS' {
        ext.prefix      = { "${meta.id}.${meta.platform}.fa.gz" }
    }

    withName: '.*:ORGANELLE_ASSEMBLY:MITOHIFI_FINDMITOREFERENCE' {
        errorStrategy = 'ignore'
        ext.args      = { "--min_length ${params.mitohifi_min_ref_len}" }
    }

    withName: '.*:ORGANELLE_ASSEMBLY:MITOHIFI_MITOHIFI_READS' {
        errorStrategy = 'ignore'
        ext.args = { params.mitohifi_reads_args ?: "" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/mito.reads" },
            mode: 'copyNoFollow',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:ORGANELLE_ASSEMBLY:MITOHIFI_MITOHIFI_CONTIGS' {
        errorStrategy = 'ignore'
        tag      = { "${meta.assembly_type}" }
        ext.args = {
            [
                "-o ${meta.mitochondrial_code}",
                params.mitohifi_contigs_args ?: ""
            ].join(' ').trim()
        }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/mito" },
            mode: 'copyNoFollow',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:ORGANELLE_ASSEMBLY:OATK' {
        ext.prefix = { "asm.k${params.oatk_kmer_size}_c${params.oatk_coverage ?: meta.coverage * 5}" }
        ext.args = {
            [
                "-k ${params.oatk_kmer_size}",
                "-c " + Math.ceil(params.oatk_coverage ?: meta.coverage * 5),
                "-Ttmp"
            ].join(' ').trim()
        }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/mito.oatk" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:POLISHING_10X:BCFTOOLS_CONSENSUS' {
        // Filter by mapping quality, keep alt-alt het and alt-alt hom,
        // keep longer allele
        ext.args = '-i\'QUAL>1 && (GT="AA" || GT="Aa")\' -Hla'
        ext.prefix = { "asm.consensus"   }
        tag        = { "${meta.assembly_type}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/polishing" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.contains('consensus.fa') ? "asm.consensus.fa" : null }
        ]
    }

    withName: '.*:POLISHING_10X:BCFTOOLS_INDEX_FB' {
        ext.prefix = { "asm.${meta.chunk_id}" }
        tag        = { "${meta.assembly_type}"      }
        ext.args   = { "--tbi" }
    }

    withName: '.*:POLISHING_10X:BCFTOOLS_INDEX_NORM' {
        ext.prefix = { "asm.${meta.chunk_id}" }
        tag        = { "${meta.assembly_type}"      }
        ext.args   = { "--tbi" }
    }

    withName: '.*:POLISHING:BCFTOOLS_NORM' {
        ext.prefix = { "asm.normalised"  }
        tag        = { "${meta.assembly_type}" }
        ext.args = '--no-version'
    }

    withName: '.*:POLISHING_10X:BCFTOOLS_SORT' {
        ext.prefix = { "asm.${meta.chunk_id}_sorted" }
        tag        = { "${meta.assembly_type}"       }
        scratch = true
    }

    withName: '.*:POLISHING_10X:BCFTOOLS_VIEW' {
        ext.prefix = { "asm.${meta.chunk_id}_view" }
        // Dont keep command line information, keep reference allele or
        // suggested alternative if reference is N
        ext.args = '--no-version -e\'type="ref"||REF~"N"\''
    }

    withName: '.*:POLISHING_10X:FREEBAYES' {
        ext.prefix = { "asm"                                    }
        ext.args   = { "--skip-coverage ${meta.longranger_cov}" }
        tag        = { "${meta.assembly_type}"                  }
    }

    withName: '.*:POLISHING_10X:GATK4_MERGE_FREEBAYES' {
        ext.prefix = { "asm.merged"            }
        tag        = { "${meta.assembly_type}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/polishing" },
            mode: params.publish_dir_mode,
            pattern: "*merged*",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:POLISHING_10X:GAWK_BED_CHUNKS' {
        tag        = { "${meta.assembly_type}" }
        ext.suffix = "bed"
        ext.args   = {
            [
                "-v prefix=asm",
                "-v chunk_size=${params.polishing_n_chunks_bed}"
            ].join(' ').trim()
        }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/polishing/chunks/" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:POLISHING_10X:LONGRANGER_MKREF' {
        tag        = { "${meta.assembly_type}" }
        container  = params.polishing_longranger_container_path
    }

    withName: '.*:POLISHING_10X:LONGRANGER_ALIGN' {
        tag        = { "${meta.assembly_type}" }
        ext.prefix = "asm"
        container  = params.polishing_longranger_container_path
        ext.args   = "--disable-ui --nopreflight"
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/polishing" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:POLISHING_10X:SAMTOOLS_FAIDX' {
        tag        = { "${meta.assembly_type}" }
    }

    withName: '.*:PURGING:CONCATENATE_HAPLOTYPES' {
        ext.prefix = { "asm.htigs.all.fa"  }
        tag        = { "${meta.assembly_type}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/purging" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:PURGING:FASTX_MAP_LONG_READS:FASTXALIGN_MINIMAP2ALIGN' {
        ext.args = {
            [
                "-x map-hifi",
                "-I" + Math.ceil(reference.size()/1e9) + "G"
            ].join(' ').trim()
        }
        tag        = { "${meta.assembly_type}" }
    }

    withName: '.*:PURGING:FASTX_MAP_LONG_READS:MINIMAP2_INDEX' {
        tag      = { "${meta.assembly_type}" }
        ext.args = {  "-I" + Math.ceil(fasta.size()/1e9)+"G" }
    }

    withName: '.*:PURGING:FASTX_MAP_LONG_READS:FASTXALIGN_PYFASTXINDEX' {
        tag        = { "${fastx.getName()}" }
    }

    withName: '.*:PURGING:MINIMAP2_ALIGN_ASSEMBLY' {
        ext.args   = { "-xasm5 -DP -I" + Math.ceil(reads.size()/1e9) + "G" }
        ext.prefix = { "asm.self_aln"                                      }
        tag        = { "${meta.assembly_type}"                             }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/purging/split_aln" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:PURGING:PURGEDUPS_PBCSTAT' {
        ext.prefix = "asm"
        tag        = { "${meta.assembly_type}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/purging/coverage" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:PURGING:PURGEDUPS_CALCUTS' {
        ext.args = {
            def cov = meta.coverage + (meta.coverage / 2)
            def l = ""
            def m = "-m ${cov}"
            def u = "-u ${cov * 4}"
            if(params.purging_cutoffs) {
                def cut_list = params.purging_cutoffs.tokenize(",")
                if(cut_list.size() != 3) {
                    log.error("Error: only ${cut_list.size()} cutoffs provided instead of 3.")
                }
                l = "-l ${cut_list[0]}"
                m = "-m ${cut_list[1]}"
                u = "-u ${cut_list[2]}"
            }

            return "${l} ${m} ${u}".trim()
        }
        ext.prefix = { "asm" }
        tag        = { "${meta.assembly_type}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/purging/coverage" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:PURGING:PURGEDUPS_PURGEDUPS' {
        ext.prefix = { "asm" }
        ext.args   = "-2"
        tag        = { "${meta.assembly_type}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/purging/purge_dups" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:PURGING:PURGEDUPS_SPLITFA' {
        ext.prefix = { "asm.self_aln"       }
        tag        = { "${meta.assembly_type}"  }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/purging/split_aln" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:PURGING:PURGEDUPS_GETSEQS' {
        ext.prefix = { "asm"                                   }
        tag        = { "${meta.assembly_type}"                 }
        ext.args   = { params.purging_purge_middle ? "" : "-e" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/purging" },
            mode: params.publish_dir_mode,
            pattern: "*.hap.fa",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:PURGING:PURGEDUPS_HISTPLOT' {
        ext.prefix = "asm"
        tag        = { "${meta.assembly_type}"                 }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/purging" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RAW_ASSEMBLY:HIFIASM' {
        ext.prefix = "asm"
        tag        = { "${meta.assembly_type}" }
        ext.args   = {
            [
                params.hifiasm_error_correction_options ? "${params.hifiasm_error_correction_options}" : "",
                params.hifiasm_assembly_options ? "${params.hifiasm_assembly_options}" : ""
            ].join(" ").trim()
        }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/" },
            mode: params.publish_dir_mode,
            pattern: "*.{gfa.gz,bin,bed.gz,log}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RAW_ASSEMBLY:HIFIASM_BIN' {
        ext.prefix = "asm"
        tag        = ""
        ext.args   = {
            [
                "--bin-only",
                params.hifiasm_error_correction_options ? "${params.hifiasm_error_correction_options}" : ""
            ].join(" ").trim()
        }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/" },
            mode: params.publish_dir_mode,
            saveAs: { filename ->
                if(filename.equals('versions.yml')) return null
                if(filename =~ /.*.log$/) {
                    def basename = filename - ~/\.log$/
                    return basename + "_bin.log"
                }
                return filename
            }
        ]
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING:BAM_SAMTOOLS_MERGE_MARKDUP:SAMTOOLS_FAIDX' {
        tag        = { "${meta.assembly_type}_${meta._hap}" }
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING:BAM_SAMTOOLS_MERGE_MARKDUP:SAMTOOLS_INDEX' {
        tag        = { "{meta.assembly_type}_${meta._hap}" }
        ext.args   = { "-c" }
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING:BAM_SAMTOOLS_MERGE_MARKDUP:SAMTOOLS_MARKDUP' {
        ext.prefix = { "asm_${meta._hap}"                   }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/scaffolding_${meta._hap}" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING:BAM_SAMTOOLS_MERGE_MARKDUP:SAMTOOLS_MERGE' {
        ext.prefix = { "asm_${meta.assembly_type}_${meta._hap}_merged" }
        ext.args   = "--write-index"
        tag        = { "${meta.assembly_type}_${meta._hap}"            }
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING:BAM_SAMTOOLS_MERGE_MARKDUP:SAMTOOLS_MERGEDUP' {
        ext.prefix = { "asm_${meta.assembly_type}_${meta._hap}_merged" }
        ext.args2  = "--write-index"
        tag        = { "${meta.assembly_type}_${meta._hap}"            }
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING:BWAMEM2_INDEX' {
        tag = { "${meta.assembly_type}" }
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING:CRAMALIGN_BWAMEM2ALIGNHIC' {
        ext.args1  = ""
        ext.args2  = "-F0xB00 -nt"
        ext.args3  = "-5SPp"
        ext.args4  = "-mpu"
        ext.args6  = "--write-index -l1"
        ext.prefix = { "${cram.getName()}.asm_${meta._hap}.${chunkn}" }
        tag        = { "${cram.getName()}.asm_${meta._hap}.${chunkn}" }
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING:CRAMALIGN_MINIMAP2ALIGNHIC' {
        ext.args1  = ""
        ext.args2  = "-F0xB00 -nt"
        ext.args3  = "-ax sr --no-pairing"
        ext.args4  = "-mpu"
        ext.args6  = "--write-index -l1"
        ext.prefix = { "${cram.getName()}.asm_${meta._hap}.${chunkn}" }
        tag        = { "${cram.getName()}.asm_${meta._hap}.${chunkn}" }
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING:MINIMAP2_INDEX' {
        tag      = { "${meta.assembly_type}"                 }
        ext.args = {  "-I" + Math.ceil(fasta.size()/1e9)+"G" }
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING:SAMTOOLS_INDEX' {
        tag      = { "${meta.assembly_type}_${meta._hap}" }
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING:SAMTOOLS_SPLITHEADER' {
        ext.prefix = { "${input.getName()}" }
        tag        = { "${input.getName()}" }
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING_STATS:SAMTOOLS_FLAGSTAT' {
        ext.prefix = { "asm_${meta._hap}"                }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/scaffolding_${meta._hap}" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING_STATS:SAMTOOLS_IDXSTATS' {
        ext.prefix = { "asm_${meta._hap}"                   }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/scaffolding_${meta._hap}" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SCAFFOLDING:HIC_MAPPING_STATS:SAMTOOLS_STATS' {
        ext.args   = "-F 0xB00"
        ext.prefix = { "asm_${meta._hap}"                   }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/scaffolding_${meta._hap}" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SCAFFOLDING:SCAFFOLDING_YAHS:BEDTOOLS_BAMTOBEDSORT' {
        ext.args1  = { "-u -q ${params.hic_mapping_minq} -F0x400" }
        ext.args2  = ""
        ext.args3  = "-k4,4"
        ext.prefix = { "asm_${meta._hap}" }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/scaffolding_${meta._hap}" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SCAFFOLDING:SCAFFOLDING_YAHS:PAIRS_CREATE_CONTACT_MAPS:COOLER_CLOAD' {
        // Positions in the input file are zero-based;
        // chrom1 field number (one-based) is 2;
        // pos1 field number (one-based) is 3;
        // chrom2 field number (one-based) is 6;
        // pos2 field number (one-based) is 7
        ext.args = '-0 -c1 2 -p1 3 -c2 4 -p2 5'
        ext.prefix = { "asm_${meta._hap}" }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
    }

    withName: '.*:SCAFFOLDING:SCAFFOLDING_YAHS:PAIRS_CREATE_CONTACT_MAPS:COOLER_ZOOMIFY' {
        ext.prefix = { "asm_${meta._hap}" }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/scaffolding_${meta._hap}/yahs/" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SCAFFOLDING:SCAFFOLDING_YAHS:PAIRS_CREATE_CONTACT_MAPS:GAWK_PROCESS_PAIRS_FILE' {
        ext.prefix = { "asm_${meta._hap}.no_chr_sizes" }
        ext.suffix = "pairs.gz"
        tag        = { "${meta.assembly_type}_${meta._hap}" }
    }

    withName: '.*:SCAFFOLDING:SCAFFOLDING_YAHS:PAIRS_CREATE_CONTACT_MAPS:JUICERTOOLS_PRE' {
        ext.prefix = { "asm_${meta._hap}" }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/scaffolding_${meta._hap}/yahs/" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SCAFFOLDING:SCAFFOLDING_YAHS:PAIRS_CREATE_CONTACT_MAPS:PRETEXTMAP' {
        ext.args = ''
        ext.prefix = { "asm_${meta._hap}" }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/scaffolding_${meta._hap}/yahs/" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SCAFFOLDING:SCAFFOLDING_YAHS:PAIRS_CREATE_CONTACT_MAPS:PRETEXTSNAPSHOT' {
        // Make one plot containing all sequences
        ext.args = '--sequences \"=full\"'
        ext.prefix = { "asm_${meta._hap}.pretext." }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/scaffolding_${meta._hap}/yahs/" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SCAFFOLDING:SCAFFOLDING_YAHS:YAHS' {
        ext.args = {
            [
                params.yahs_break_contigs ? "" : "--no-contig-ec",
                params.yahs_resolutions ? "-r ${params.yahs_resolutions}" : "",
                params.yahs_min_contig_length ? "-l ${params.yahs_min_contig_length}" : ""
            ].join(' ').trim()
        }
        ext.prefix = { "asm_${meta._hap}" }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
        publishDir = [
            path: { "${params.outdir}/${mf.assemblyDir(meta, workflow.start)}/scaffolding_${meta._hap}/yahs/" },
            mode: params.publish_dir_mode,
            pattern: "*.{agp,log,bin}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SCAFFOLDING:SCAFFOLDING_YAHS:YAHS_MAKEPAIRSFILE' {
        ext.prefix = { "asm_${meta._hap}" }
        tag        = { "${meta.assembly_type}_${meta._hap}" }
    }

}
